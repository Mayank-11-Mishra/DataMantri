{% extends "base.html" %}

{% block title %}AI Dashboard - DataViz AI{% endblock %}

{% block extra_css %}
<style>
    .ai-dashboard-layout {
        display: grid;
        grid-template-columns: 350px 1fr;
        gap: 2rem;
        height: calc(100vh - 120px); /* Adjust based on navbar height and padding */
    }

    .chat-panel {
        display: flex;
        flex-direction: column;
        background-color: var(--card-bg);
        border-radius: 12px;
        border: 1px solid var(--border-color);
        box-shadow: var(--shadow-sm);
    }

    .chat-header {
        padding: 1rem 1.5rem;
        font-weight: 600;
        border-bottom: 1px solid var(--border-color);
    }

    .chat-body {
        flex-grow: 1;
        overflow-y: auto;
        padding: 1.5rem;
    }

    .chat-footer {
        padding: 1rem;
        border-top: 1px solid var(--border-color);
    }

    .message {
        margin-bottom: 1.5rem;
        display: flex;
        max-width: 90%;
    }

    .message .avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: var(--primary-color);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        margin-right: 12px;
        flex-shrink: 0;
    }

    .message.user-message {
        margin-left: auto;
        flex-direction: row-reverse;
    }

    .message.user-message .avatar {
        margin-right: 0;
        margin-left: 12px;
        background-color: #78909C;
    }

    .message-content {
        padding: 12px 16px;
        border-radius: 18px;
        background-color: #F1F3F5;
    }
    
    .message.user-message .message-content {
        background-color: var(--primary-color);
        color: white;
        border-radius: 18px 18px 4px 18px;
    }

    .message.ai-message .message-content {
        border-radius: 4px 18px 18px 18px;
    }

    .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 1.5rem;
        align-content: start;
        height: 100%;
        overflow-y: auto;
        padding: 0.5rem;
    }

    .dashboard-placeholder {
        grid-column: 1 / -1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        height: 50vh;
        color: var(--text-secondary);
        border: 2px dashed var(--border-color);
        border-radius: 12px;
    }

    .dashboard-placeholder .bi {
        font-size: 4rem;
        margin-bottom: 1rem;
    }

    .widget {
        background-color: var(--card-bg);
        border-radius: 12px;
        border: 1px solid var(--border-color);
        box-shadow: var(--shadow-sm);
        padding: 1.5rem;
        height: 350px; /* Give widgets a fixed height */
        display: flex;
        flex-direction: column;
    }

    .widget canvas {
        flex-grow: 1;
    }

</style>
{% endblock %}

{% block content %}
<h1 class="page-title">AI Dashboard</h1>

<div class="ai-dashboard-layout">
    <!-- Chat Panel -->
    <div class="chat-panel">
        <div class="chat-header">AI Assistant</div>
        <div class="p-3 border-bottom">
            <label for="dataSourceSelect" class="form-label fw-bold">Data Source</label>
            <select class="form-select" id="dataSourceSelect">
                <option selected>Choose a data source...</option>
            </select>
            <div class="mt-2">
                <label for="tableSelect" class="form-label fw-bold">Table</label>
                <select class="form-select" id="tableSelect" disabled>
                    <option selected>Select a table...</option>
                </select>
            </div>
            <div id="schemaDisplay" class="mt-3 small text-muted" style="max-height: 150px; overflow-y: auto;"></div>
        </div>
        <div class="chat-body" id="chatContainer">
            <div class="message ai-message">
                <div class="avatar">AI</div>
                <div class="message-content">
                    <p class="mb-0">Hello! Select a data source and tell me what you'd like to visualize.</p>
                </div>
            </div>
        </div>
        <div class="chat-footer">
            <div class="input-group">
                <input type="text" class="form-control" id="userInput" placeholder="e.g., 'Show total sales by region'" autocomplete="off">
                <button class="btn btn-primary" id="sendMessage" type="button">
                    <i class="bi bi-send"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Dashboard Preview -->
    <div class="dashboard-grid" id="dashboardGrid">
        <div class="dashboard-placeholder" id="dashboardPlaceholder">
            <i class="bi bi-columns-gap"></i>
            <h4 class="mt-3">Your dashboard will appear here</h4>
            <p>Use the chat to generate charts and visualizations.</p>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // DOM Elements
    const chatContainer = document.getElementById('chatContainer');
    const userInput = document.getElementById('userInput');
    const sendMessageBtn = document.getElementById('sendMessage');
    const dataSourceSelect = document.getElementById('dataSourceSelect');
    const schemaDisplay = document.getElementById('schemaDisplay');
    const tableSelect = document.getElementById('tableSelect');
    const dashboardGrid = document.getElementById('dashboardGrid');
    const dashboardPlaceholder = document.getElementById('dashboardPlaceholder');

    let fullSchema = {}; // To store the complete schema

    // --- Event Listeners ---
    sendMessageBtn.addEventListener('click', sendMessage);
    userInput.addEventListener('keypress', e => { if (e.key === 'Enter') sendMessage(); });
    dataSourceSelect.addEventListener('change', async () => {
        const sourceId = dataSourceSelect.value;
        if (sourceId && sourceId !== 'Choose a data source...') {
            await loadSchemaForAI(sourceId);
        } else {
            tableSelect.innerHTML = '<option selected>Select a table...</option>';
            tableSelect.disabled = true;
            schemaDisplay.innerHTML = '';
        }
    });

    tableSelect.addEventListener('change', () => {
        const tableName = tableSelect.value;
        if (tableName && tableName !== 'Select a table...') {
            displayTableSchema(tableName, fullSchema[tableName]);
        } else {
            schemaDisplay.innerHTML = '';
        }
    });

    // --- Chat Functions ---
    function addMessage(content, type) {
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('message', `${type}-message`);

        const avatar = document.createElement('div');
        avatar.classList.add('avatar');
        avatar.textContent = type === 'user' ? 'You' : 'AI';

        const messageContent = document.createElement('div');
        messageContent.classList.add('message-content');
        messageContent.innerHTML = `<p class="mb-0">${content}</p>`;

        messageDiv.appendChild(avatar);
        messageDiv.appendChild(messageContent);
        chatContainer.appendChild(messageDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    async function sendMessage() {
        const message = userInput.value.trim();
        if (!message) return;

        addMessage(message, 'user');
        userInput.value = '';

        const sourceId = dataSourceSelect.value;
        const tableName = tableSelect.value;

        if (!sourceId || sourceId === 'Choose a data source...') {
            addMessage('Please select a data source first.', 'ai');
            return;
        }
        if (!tableName || tableName === 'Select a table...') {
            addMessage('Please select a table first.', 'ai');
            return;
        }

        try {
            const response = await fetch('/api/ai/query', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt: message, source_id: sourceId, table: tableName })
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const result = await response.json();
            processAIResponse(result);

        } catch (error) {
            console.error('Error querying AI:', error);
            addMessage('Sorry, I had trouble processing that request. Please try again.', 'ai');
        }
    }

    function processAIResponse(response) {
        if (response.message) {
            addMessage(response.message, 'ai');
        }

        if (response.type === 'chart') {
            createChartWidget(response);
        }
    }

    // --- Data Source & Schema Functions ---
    async function loadDataSourcesForAI() {
        try {
            const response = await fetch('/api/data-sources');
            const sources = await response.json();
            sources.forEach(source => {
                const option = document.createElement('option');
                option.value = source.id;
                option.textContent = source.name;
                dataSourceSelect.appendChild(option);
            });
        } catch (error) {
            console.error('Failed to load data sources:', error);
        }
    }

    async function loadSchemaForAI(sourceId) {
        schemaDisplay.innerHTML = '<em>Loading schema...</em>';
        tableSelect.innerHTML = '<option selected>Loading tables...</option>';
        tableSelect.disabled = true;

        try {
            const response = await fetch(`/api/data-sources/${sourceId}/schema`);
            const result = await response.json();

            if (result.status === 'success') {
                fullSchema = result.schema;
                tableSelect.innerHTML = '<option selected>Select a table...</option>';
                Object.keys(fullSchema).forEach(table => {
                    const option = document.createElement('option');
                    option.value = table;
                    option.textContent = table;
                    tableSelect.appendChild(option);
                });
                tableSelect.disabled = false;
                schemaDisplay.innerHTML = 'Select a table to see its columns.';
            } else {
                throw new Error(result.message);
            }
        } catch (error) {
            schemaDisplay.innerHTML = `<em class="text-danger">Failed to load schema.</em>`;
            tableSelect.innerHTML = '<option selected>Failed to load</option>';
            console.error('Schema loading error:', error);
        }
    }

    function displayTableSchema(tableName, columns) {
        let schemaHtml = `<strong>Columns in ${tableName}:</strong><ul>`;
        columns.forEach(col => {
            schemaHtml += `<li>${col.name} <span class="opacity-50">(${col.type})</span></li>`;
        });
        schemaHtml += '</ul>';
        schemaDisplay.innerHTML = schemaHtml;
    }

    // --- Dashboard & Chart Functions ---
    function createChartWidget(chartInfo) {
        if (dashboardPlaceholder) {
            dashboardPlaceholder.style.display = 'none';
        }

        const widgetId = 'widget-' + Date.now();
        const widget = document.createElement('div');
        widget.id = widgetId;
        widget.classList.add('widget');
        widget.innerHTML = `
            <h6 class="widget-title">${chartInfo.title}</h6>
            <canvas></canvas>
        `;
        dashboardGrid.appendChild(widget);

        const canvas = widget.querySelector('canvas');
        const ctx = canvas.getContext('2d');

        // Get theme colors from CSS variables
        const style = getComputedStyle(document.documentElement);
        const textColor = style.getPropertyValue('--text-color').trim();
        const gridColor = style.getPropertyValue('--border-color').trim();
        const primaryColor = style.getPropertyValue('--primary-color').trim();
        const secondaryColor = style.getPropertyValue('--secondary-color').trim();

        const data = chartInfo.data;
        const colorPalette = [primaryColor, secondaryColor, '#E74C3C', '#9B59B6', '#34495E'];
        data.datasets.forEach((dataset, index) => {
            dataset.backgroundColor = dataset.backgroundColor || colorPalette[index % colorPalette.length] + '80';
            dataset.borderColor = dataset.borderColor || colorPalette[index % colorPalette.length];
            dataset.borderWidth = 2;
        });

        new Chart(ctx, {
            type: chartInfo.chartType,
            data: data,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { ticks: { color: textColor }, grid: { color: gridColor } },
                    y: { ticks: { color: textColor }, grid: { color: gridColor } }
                },
                plugins: {
                    legend: { labels: { color: textColor } }
                }
            }
        });
    }

    // --- Initial Load ---
    loadDataSourcesForAI();
});
</script>
{% endblock %}
