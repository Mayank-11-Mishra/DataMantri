{% extends "base.html" %}

{% block title %}Upload Utility - DataViz AI{% endblock %}

{% block extra_css %}
<style>
    .upload-area {
        border: 2px dashed var(--border-color);
        border-radius: 12px;
        padding: 3rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background-color: var(--content-bg);
    }
    .upload-area:hover, .upload-area.dragover {
        border-color: var(--primary-color);
        background-color: #E9F2FC;
    }
    .upload-area .bi {
        font-size: 3rem;
        color: var(--primary-color);
    }
    .file-info-card {
        background-color: #F8F9FA;
        border: 1px solid var(--border-color);
    }
</style>
{% endblock %}

{% block content %}
<h1 class="page-title">Upload Utility</h1>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">Upload New File</div>
            <div class="card-body p-4">
                <form id="uploadForm" enctype="multipart/form-data">
                    <div class="row">
                        <div class="col-lg-8">
                            <div id="uploadArea" class="upload-area d-flex flex-column justify-content-center align-items-center h-100">
                                <div id="uploadContent">
                                    <i class="bi bi-cloud-arrow-up mb-3"></i>
                                    <h5>Drag & drop your file here</h5>
                                    <p class="text-muted mb-2">or click to browse</p>
                                    <small class="text-muted">Supports: .csv, .xlsx (Max 16MB)</small>
                                    <input type="file" id="fileInput" name="file" accept=".csv,.xlsx" class="d-none">
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="mb-3">
                                <label for="fileType" class="form-label fw-bold">File Type</label>
                                <select class="form-select" id="fileType" name="file_type" required>
                                    <option value="" selected disabled>Select a file type...</option>
                                    <option value="marzi_zoho_lead">Marzi Zoho Lead Data</option>
                                    <option value="other">Other Data</option>
                                </select>
                            </div>
                            <div id="fileInfo" class="file-info-card p-3 rounded d-none">
                                <h6 class="fw-bold">Selected File:</h6>
                                <p id="fileName" class="mb-1"></p>
                                <p id="fileSize" class="small text-muted"></p>
                                <div class="progress" style="height: 5px;">
                                    <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%;"></div>
                                </div>
                            </div>
                            <div class="d-grid mt-3">
                                <button type="submit" id="uploadBtn" class="btn btn-primary btn-lg">Upload File</button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <div class="card mt-4">
            <div class="card-header">Upload History</div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th scope="col">Filename</th>
                                <th scope="col">Type</th>
                                <th scope="col">Status</th>
                                <th scope="col">Uploaded</th>
                                <th scope="col">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="uploadHistory">
                            <tr id="noHistory">
                                <td colspan="5" class="text-center text-muted p-4">No upload history yet.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Upload Details Modal -->
<div class="modal fade" id="uploadDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Upload Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="uploadDetailsContent"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const fileInfo = document.getElementById('fileInfo');
    const fileNameEl = document.getElementById('fileName');
    const fileSizeEl = document.getElementById('fileSize');
    const progressBar = document.getElementById('progressBar');
    const uploadForm = document.getElementById('uploadForm');
    const uploadBtn = document.getElementById('uploadBtn');
    const uploadHistoryBody = document.getElementById('uploadHistory');

    // Drag and Drop
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, preventDefaults, false);
        document.body.addEventListener(eventName, preventDefaults, false);
    });
    ['dragenter', 'dragover'].forEach(eventName => {
        uploadArea.addEventListener(eventName, () => uploadArea.classList.add('dragover'), false);
    });
    ['dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, () => uploadArea.classList.remove('dragover'), false);
    });

    uploadArea.addEventListener('drop', e => handleFiles(e.dataTransfer.files), false);
    uploadArea.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', e => handleFiles(e.target.files));

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    function handleFiles(files) {
        if (files.length === 0) return;
        const file = files[0];
        
        const validTypes = ['text/csv', 'application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'];
        if (!validTypes.includes(file.type) && !file.name.endsWith('.csv') && !file.name.endsWith('.xlsx')) {
            alert('Invalid file type. Please upload a CSV or Excel file.');
            return;
        }

        fileInput.files = files;
        fileNameEl.textContent = file.name;
        fileSizeEl.textContent = `${(file.size / 1024 / 1024).toFixed(2)} MB`;
        fileInfo.classList.remove('d-none');
        progressBar.style.width = '0%';
    }

    // Form Submission
    uploadForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const file = fileInput.files[0];
        const fileType = document.getElementById('fileType').value;

        if (!file) { return alert('Please select a file.'); }
        if (!fileType) { return alert('Please select a file type.'); }

        const formData = new FormData();
        formData.append('file', file);
        formData.append('file_type', fileType);

        const xhr = new XMLHttpRequest();
        xhr.open('POST', '/upload', true); // Assuming '/upload' is the correct endpoint

        xhr.upload.addEventListener('progress', function(e) {
            if (e.lengthComputable) {
                const percentComplete = (e.loaded / e.total) * 100;
                progressBar.style.width = percentComplete + '%';
            }
        });

        xhr.onload = function() {
            uploadBtn.disabled = false;
            uploadBtn.innerHTML = 'Upload File';
            if (xhr.status === 200) {
                alert('Upload successful!'); // Replace with better notification
                loadUploadHistory();
            } else {
                alert('Upload failed. Check console for details.');
                console.error('Upload failed:', xhr.responseText);
            }
        };

        xhr.onerror = function() {
            alert('An error occurred during the upload. Please try again.');
            uploadBtn.disabled = false;
            uploadBtn.innerHTML = 'Upload File';
        };

        uploadBtn.disabled = true;
        uploadBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Uploading...';
        xhr.send(formData);
    });

    // Load History
    async function loadUploadHistory() {
        // This part depends on an endpoint to fetch history, which we can add.
        // For now, it will just clear the placeholder.
        const noHistoryRow = document.getElementById('noHistory');
        if(noHistoryRow) noHistoryRow.remove();
        // Example row:
        // const row = `<tr><td>example.csv</td><td>OTHER</td><td><span class="badge bg-success">Completed</span></td><td>Just now</td><td><button class="btn btn-sm btn-outline-secondary">Details</button></td></tr>`;
        // uploadHistoryBody.insertAdjacentHTML('afterbegin', row);
    }

    loadUploadHistory();
});
</script>
{% endblock %}
