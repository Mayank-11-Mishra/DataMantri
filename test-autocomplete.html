<!DOCTYPE html>
<html>
<head>
    <title>SQL Autocomplete Test</title>
    <script src="https://unpkg.com/monaco-editor@0.44.0/min/vs/loader.js"></script>
</head>
<body>
    <div id="container" style="width: 800px; height: 400px; border: 1px solid #ccc;"></div>
    
    <script>
        require.config({ paths: { vs: 'https://unpkg.com/monaco-editor@0.44.0/min/vs' } });
        
        require(['vs/editor/editor.main'], function () {
            // Test data
            const testSchema = {
                tables: ['users', 'orders', 'products', 'test_users'],
                schema: {
                    users: [
                        { column_name: 'id', data_type: 'integer', is_nullable: 'NO' },
                        { column_name: 'username', data_type: 'varchar', is_nullable: 'NO' },
                        { column_name: 'email', data_type: 'varchar', is_nullable: 'NO' }
                    ],
                    orders: [
                        { column_name: 'id', data_type: 'integer', is_nullable: 'NO' },
                        { column_name: 'user_id', data_type: 'integer', is_nullable: 'NO' },
                        { column_name: 'total', data_type: 'decimal', is_nullable: 'YES' }
                    ]
                }
            };

            // Create editor
            const editor = monaco.editor.create(document.getElementById('container'), {
                value: 'SELECT * FROM ',
                language: 'sql',
                theme: 'vs-dark',
                suggest: {
                    showKeywords: true,
                    showSnippets: true,
                    showFunctions: true,
                    showClasses: true,
                    showFields: true
                },
                quickSuggestions: true
            });

            // Register completion provider
            monaco.languages.registerCompletionItemProvider('sql', {
                provideCompletionItems: function(model, position) {
                    const suggestions = [];
                    
                    const word = model.getWordUntilPosition(position);
                    const range = {
                        startLineNumber: position.lineNumber,
                        endLineNumber: position.lineNumber,
                        startColumn: word.startColumn,
                        endColumn: word.endColumn,
                    };

                    // Add table suggestions
                    testSchema.tables.forEach(tableName => {
                        suggestions.push({
                            label: tableName,
                            kind: monaco.languages.CompletionItemKind.Class,
                            insertText: tableName,
                            range: range,
                            detail: 'Table'
                        });
                    });

                    // Add column suggestions
                    Object.entries(testSchema.schema).forEach(([tableName, columns]) => {
                        columns.forEach(column => {
                            suggestions.push({
                                label: column.column_name,
                                kind: monaco.languages.CompletionItemKind.Field,
                                insertText: column.column_name,
                                range: range,
                                detail: `Column (${column.data_type})`
                            });
                        });
                    });

                    console.log('Providing suggestions:', suggestions.length);
                    return { suggestions: suggestions };
                }
            });

            // Auto-trigger on typing
            editor.onDidChangeModelContent(() => {
                setTimeout(() => {
                    editor.trigger('auto', 'editor.action.triggerSuggest', {});
                }, 100);
            });
        });
    </script>
</body>
</html>
