{% extends "base.html" %}

{% block title %}Dashboard - Zoho Data Uploader{% endblock %}

{% block extra_css %}
<style>
    .upload-area {
        border: 2px dashed #ccc;
        border-radius: 8px;
        padding: 2rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
        margin-bottom: 2rem;
    }
    .upload-area:hover {
        border-color: #0d6efd;
        background-color: #f8f9fa;
    }
    .upload-area.dragover {
        border-color: #0d6efd;
        background-color: #e7f1ff;
    }
    .file-info {
        display: none;
        margin-top: 1.5rem;
    }
    .progress {
        height: 10px;
        margin-top: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">Welcome, {{ user.email }}</h1>
        
        <div class="card shadow mb-4">
            <div class="card-header bg-white">
                <h5 class="mb-0">Upload Zoho Data</h5>
            </div>
            <div class="card-body">
                <form id="uploadForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="fileType" class="form-label">Select File Type</label>
                        <select class="form-select" id="fileType" name="file_type" required>
                            <option value="" selected disabled>Select file type...</option>
                            <option value="marzi_zoho_lead">Marzi Zoho Lead Data</option>
                            <option value="other">Other Data</option>
                        </select>
                    </div>
                    
                    <div id="uploadArea" class="upload-area">
                        <div id="uploadContent">
                            <i class="bi bi-cloud-arrow-up fs-1 text-muted"></i>
                            <h5>Drag & drop your file here</h5>
                            <p class="text-muted">or click to browse files</p>
                            <small class="text-muted">Supports: .csv, .xlsx (Max 16MB)</small>
                            <input type="file" id="fileInput" name="file" accept=".csv,.xlsx" style="display: none;">
                        </div>
                        <div class="alert alert-danger alert-dismissible fade show" id="errorAlert" style="display: none;">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                            <span id="errorMessage">Error message will appear here</span>
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>

                        <div class="alert alert-success alert-dismissible fade show" id="successAlert" style="display: none;">
                            <i class="bi bi-check-circle-fill me-2"></i>
                            <div id="successMessage">
                                <p>File uploaded successfully!</p>
                                <div id="uploadStats" class="mt-2"></div>
                            </div>
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                        
                        <div class="card mb-4" id="uploadStatusCard" style="display: none;">
                            <div class="card-header">
                                <h5 class="mb-0">Upload Status</h5>
                            </div>
                            <div class="card-body">
                                <div class="progress mb-3" style="height: 25px;">
                                    <div id="uploadProgress" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%">0%</div>
                                </div>
                                <div id="statusDetails" class="small">
                                    <div class="d-flex justify-content-between mb-1">
                                        <span>Status:</span>
                                        <span id="currentStatus">Preparing to upload...</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-1">
                                        <span>Processed:</span>
                                        <span id="processedCount">0</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-1">
                                        <span>Success:</span>
                                        <span id="successCount">0</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-1">
                                        <span>Failed:</span>
                                        <span id="failedCount">0</span>
                                    </div>
                                    <div id="errorList" class="mt-2 small text-danger"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="fileInfo" class="file-info">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0">Selected File:</h6>
                            <span id="fileName" class="fw-bold"></span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <span class="text-muted">File Size:</span>
                            <span id="fileSize" class="fw-bold"></span>
                        </div>
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <button type="button" id="cancelBtn" class="btn btn-outline-secondary me-md-2">Cancel</button>
                            <button type="submit" id="uploadBtn" class="btn btn-primary">
                                <span id="uploadBtnText">Upload File</span>
                                <span id="uploadSpinner" class="spinner-border spinner-border-sm d-none" role="status"></span>
                            </button>
                        </div>
                        
                        <div class="progress mt-3 d-none" id="progressBarContainer">
                            <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        
        <div class="card shadow">
            <div class="card-header bg-white">
                <h5 class="mb-0">Upload History</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Filename</th>
                                <th>Type</th>
                                <th>Status</th>
                                <th>Uploaded</th>
                                <th>Transformed</th>
                                <th>Updated</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Will be populated by JavaScript -->
                            <tr id="noHistory">
                                <td colspan="7" class="text-center text-muted py-4">
                                    No upload history available
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Upload Details Modal -->
<div class="modal fade" id="uploadDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Upload Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="uploadDetailsContent">
                <!-- Will be populated by JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Alerts Container -->
<div id="alertsContainer"></div>

{% endblock %}

{% block extra_js %}
<script>
function showAlert(message, type = 'info') {
    // Remove any existing alerts
    const existingAlerts = document.querySelectorAll('.alert');
    existingAlerts.forEach(alert => {
        const bsAlert = bootstrap.Alert.getOrCreateInstance(alert);
        bsAlert.close();
    });

    // Create new alert
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.role = 'alert';
    alertDiv.style.transition = 'opacity 0.5s ease-in-out';
    
    // Add icon based on alert type
    let icon = '';
    switch(type) {
        case 'success':
            icon = '<i class="bi bi-check-circle-fill me-2"></i>';
            break;
        case 'danger':
            icon = '<i class="bi bi-exclamation-triangle-fill me-2"></i>';
            break;
        case 'warning':
            icon = '<i class="bi bi-exclamation-circle-fill me-2"></i>';
            break;
        default:
            icon = '<i class="bi bi-info-circle-fill me-2"></i>';
    }
    
    alertDiv.innerHTML = `
        <div class="d-flex align-items-center">
            ${icon}
            <div>${message}</div>
            <button type="button" class="btn-close ms-auto" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    `;
    
    const container = document.getElementById('alertsContainer');
    container.prepend(alertDiv);
    
    // Initialize Bootstrap alert
    const bsAlert = new bootstrap.Alert(alertDiv);
    
    // Auto-dismiss after appropriate time
    const dismissTime = type === 'danger' ? 10000 : 5000; // Show errors longer
    setTimeout(() => {
        if (document.body.contains(alertDiv)) {
            bsAlert.close();
        }
    }, dismissTime);
}

$(document).ready(function() {
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const fileInfo = document.getElementById('fileInfo');
    const uploadHistory = $('#uploadHistory tbody');
    const uploadForm = document.getElementById('uploadForm');
    const uploadBtn = document.getElementById('uploadBtn');
    const uploadBtnText = document.getElementById('uploadBtnText');
    const uploadSpinner = document.getElementById('uploadSpinner');
    const progressBar = document.getElementById('uploadProgress');
    const progressBarContainer = document.querySelector('.progress');
    const currentStatus = document.getElementById('currentStatus');
    const processedCount = document.getElementById('processedCount');
    const successCount = document.getElementById('successCount');
    const failedCount = document.getElementById('failedCount');
    const errorList = document.getElementById('errorList');
    const successAlert = document.getElementById('successAlert');
    const errorAlert = document.getElementById('errorAlert');
    const errorMessage = document.getElementById('errorMessage');
    const uploadStatusCard = document.getElementById('uploadStatusCard');
    
    // Initialize elements if they exist
    if (progressBar) progressBar.style.width = '0%';
    if (progressBar) progressBar.setAttribute('aria-valuenow', 0);
    if (progressBarContainer) progressBarContainer.style.display = 'none';
    
    // Prevent default drag behaviors
    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }
    
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, preventDefaults, false);
        document.body.addEventListener(eventName, preventDefaults, false);
    });
    
    ['dragenter', 'dragover'].forEach(eventName => {
        uploadArea.addEventListener(eventName, highlight, false);
    });
    
    function highlight() {
        uploadArea.classList.add('dragover');
    }
    
    function unhighlight() {
        uploadArea.classList.remove('dragover');
    }
    
    // Handle dropped files
    uploadArea.addEventListener('drop', handleDrop, false);
    
    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        handleFiles(files);
    }
    
    // Handle click on upload area
    uploadArea.addEventListener('click', () => {
        fileInput.click();
    });
    
    // Handle file selection
    fileInput.addEventListener('change', function() {
        if (this.files.length) {
            handleFiles(this.files);
        }
    });
    
    // Handle cancel button
    document.getElementById('cancelBtn').addEventListener('click', resetUploadForm);
    
    function handleFiles(files) {
        const file = files[0];
        
        // Validate file type
        const fileType = file.name.split('.').pop().toLowerCase();
        if (!['csv', 'xlsx'].includes(fileType)) {
            showAlert('Only CSV and Excel files are allowed.', 'danger');
            return;
        }
        
        // Update UI
        document.getElementById('fileName').textContent = file.name;
        document.getElementById('fileSize').textContent = formatFileSize(file.size);
        fileInfo.style.display = 'block';
        
        // Scroll to file info
        fileInfo.scrollIntoView({ behavior: 'smooth' });
    }
    
    // Format file size
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    // Handle form submission
    uploadForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const file = fileInput.files[0];
        const fileType = document.getElementById('fileType').value;
        
        if (!file) {
            showAlert('Please select a file to upload.', 'danger');
            return;
        }
        
        if (!fileType) {
            showAlert('Please select a file type.', 'danger');
            return;
        }
        
        // Reset UI
        if (errorAlert) errorAlert.style.display = 'none';
        if (successAlert) successAlert.style.display = 'none';
        if (uploadStatusCard) uploadStatusCard.style.display = 'block';
        if (errorList) errorList.innerHTML = '';
        
        // Show loading state
        if (uploadBtn) uploadBtn.disabled = true;
        if (uploadBtnText) uploadBtnText.textContent = 'Uploading...';
        if (uploadSpinner) uploadSpinner.classList.remove('d-none');
        if (progressBarContainer) progressBarContainer.style.display = 'block';
        if (progressBar) {
            progressBar.style.width = '0%';
            progressBar.setAttribute('aria-valuenow', 0);
            progressBar.textContent = '0%';
        }
        if (currentStatus) currentStatus.textContent = 'Starting upload...';
        if (processedCount) processedCount.textContent = '0';
        if (successCount) successCount.textContent = '0';
        if (failedCount) failedCount.textContent = '0';
        
        // Create form data
        const formData = new FormData();
        formData.append('file', file);
        formData.append('file_type', fileType);
        
        // Create XMLHttpRequest for upload progress
        const xhr = new XMLHttpRequest();
        
        xhr.upload.addEventListener('progress', function(e) {
            if (e.lengthComputable) {
                const percentComplete = Math.round((e.loaded / e.total) * 100);
                if (progressBar) {
                    progressBar.style.width = percentComplete + '%';
                    progressBar.setAttribute('aria-valuenow', percentComplete);
                    progressBar.textContent = percentComplete + '%';
                }
                
                // Update status
                if (currentStatus) {
                    if (percentComplete < 100) {
                        currentStatus.textContent = `Uploading: ${percentComplete}%`;
                    } else {
                        currentStatus.textContent = 'Processing file...';
                    }
                }
            }
        });
        
        xhr.onreadystatechange = function() {
            if (xhr.readyState === 4) {
                if (uploadBtn) uploadBtn.disabled = false;
                if (uploadBtnText) uploadBtnText.textContent = 'Upload File';
                if (uploadSpinner) uploadSpinner.classList.add('d-none');
                
                console.log('Server response status:', xhr.status);
                console.log('Response text:', xhr.responseText);
                
                try {
                    let response;
                    try {
                        // First try to parse as JSON
                        response = JSON.parse(xhr.responseText);
                    } catch (e) {
                        console.warn('Response is not valid JSON, treating as plain text');
                        response = { message: xhr.responseText };
                    }
                    
                    if (xhr.status === 200) {
                        if (response.status === 'success' || response.status === 'partial_success') {
                            // Show success message
                            showAlert('File uploaded successfully!', 'success');
                            
                            // Update status card
                            const stats = response.file_info?.stats || {};
                            if (currentStatus) currentStatus.textContent = 'Upload completed';
                            if (processedCount) processedCount.textContent = stats.processed || 0;
                            if (successCount) successCount.textContent = stats.success || 0;
                            if (failedCount) failedCount.textContent = stats.failed || 0;
                            
                            // Show errors if any
                            if (stats.errors && stats.errors.length > 0 && errorList) {
                                errorList.innerHTML = '';
                                stats.errors.slice(0, 5).forEach(error => {
                                    const li = document.createElement('li');
                                    li.textContent = error;
                                    errorList.appendChild(li);
                                });
                                if (stats.errors.length > 5) {
                                    const li = document.createElement('li');
                                    li.textContent = `...and ${stats.errors.length - 5} more errors`;
                                    errorList.appendChild(li);
                                }
                            }
                            
                            // Show success alert
                            if (successAlert) successAlert.style.display = 'block';
                            if (uploadStatusCard) uploadStatusCard.style.display = 'block';
                            
                            // Add to upload history if we have the upload data
                            if (response.upload_id) {
                                // Fetch the latest upload details
                                fetch(`/api/upload/${response.upload_id}`)
                                    .then(res => res.json())
                                    .then(uploadData => {
                                        addToUploadHistory(uploadData);
                                    })
                                    .catch(e => console.error('Error fetching upload details:', e));
                            }
                            
                        } else {
                            throw new Error(response.message || 'Unknown error occurred during processing');
                        }
                    } else {
                        // Handle non-200 status codes
                        const errorMsg = response.message || 
                                      response.details || 
                                      `Server returned status ${xhr.status}`;
                        throw new Error(errorMsg);
                    }
                } catch (e) {
                    console.error('Error processing response:', e);
                    const errorMessage = e.message || 'An unknown error occurred during file upload';
                    showAlert(errorMessage, 'danger');
                }
            }
        };
        
        xhr.onerror = function() {
            showAlert('Network error occurred. Please try again.', 'danger');
            if (uploadBtn) uploadBtn.disabled = false;
            if (uploadBtnText) uploadBtnText.textContent = 'Upload File';
            if (uploadSpinner) uploadSpinner.classList.add('d-none');
        };
        
        xhr.open('POST', '/upload', true);
        xhr.send(formData);
    });
    
    // Reset upload form
    function resetUploadForm() {
        fileInput.value = '';
        fileInfo.style.display = 'none';
        document.getElementById('fileType').selectedIndex = 0;
    }
    
    // Format time for display
    function formatTime(dateString) {
        if (!dateString) return '-';
        const date = new Date(dateString);
        return date.toLocaleTimeString('en-US', {
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
    }
    
    // Get badge class based on status
    function getStatusBadge(status) {
        const statusMap = {
            'uploaded': 'bg-info',
            'transforming': 'bg-primary',
            'transformed': 'bg-info',
            'completed': 'bg-success',
            'failed': 'bg-danger',
            'processing': 'bg-warning'
        };
        return statusMap[status] || 'bg-secondary';
    }
    
    // Add upload to history
    function addToUploadHistory(upload) {
        // Hide "no history" message if it's the first upload
        $('#noHistory').hide();
        
        const row = `
            <tr>
                <td>${upload.filename || 'N/A'}</td>
                <td>${upload.file_type ? upload.file_type.replace('_', ' ').toUpperCase() : 'N/A'}</td>
                <td><span class="badge ${getStatusBadge(upload.status || 'unknown')}">${upload.status || 'unknown'}</span></td>
                <td class="text-center">
                    ${upload.upload_time ? 
                        `<i class="bi bi-check-circle-fill text-success"></i>
                        <div class="small text-muted">${formatTime(upload.upload_time)}</div>` : 
                        '<i class="bi bi-dash-circle text-muted"></i>'}
                </td>
                <td class="text-center">
                    ${upload.transform_time ? 
                        `<i class="bi bi-check-circle-fill text-success"></i>
                        <div class="small text-muted">${formatTime(upload.transform_time)}</div>` : 
                        '<i class="bi bi-dash-circle text-muted"></i>'}
                </td>
                <td class="text-center">
                    ${upload.update_time ? 
                        `<i class="bi bi-check-circle-fill text-success"></i>
                        <div class="small text-muted">${formatTime(upload.update_time)}</div>` : 
                        '<i class="bi bi-dash-circle text-muted"></i>'}
                </td>
                <td>
                    <button class="btn btn-sm btn-outline-primary view-details" 
                            data-upload-id="${upload.id}">
                        <i class="bi bi-info-circle"></i> Details
                    </button>
                </td>
            </tr>
        `;
        
        // Add to the beginning of the table
        uploadHistory.prepend(row);
        
        // Add click handler for the view details button
        $('.view-details').off('click').on('click', function() {
            const uploadId = $(this).data('upload-id');
            // Fetch the full upload details from the server
            fetch(`/api/upload/${uploadId}`)
                .then(response => response.json())
                .then(upload => {
                    const details = {
                        filename: upload.filename,
                        type: upload.file_type,
                        status: upload.status,
                        uploaded: upload.upload_time ? new Date(upload.upload_time).toLocaleString() : 'N/A',
                        transformed: upload.transform_time ? new Date(upload.transform_time).toLocaleString() : 'N/A',
                        updated: upload.update_time ? new Date(upload.update_time).toLocaleString() : 'N/A',
                        records_processed: upload.records_processed || 0,
                        records_failed: upload.records_failed || 0,
                        error_message: upload.error_message || 'No errors'
                    };
                    showUploadDetails(details);
                })
                .catch(error => {
                    console.error('Error fetching upload details:', error);
                    showAlert('Failed to load upload details', 'danger');
                });
        });
    }
    
    // Show upload details in modal
    function showUploadDetails(details) {
        if (!details) {
            console.error('No upload details provided');
            showAlert('No upload details available', 'warning');
            return;
        }
        
        const status = details.status || 'unknown';
        const statusClass = getStatusBadge(status).replace('bg-', 'text-');
        
        const detailsHtml = `
            <div class="mb-3">
                <h6>File Information</h6>
                <table class="table table-sm">
                    <tr>
                        <th style="width: 160px;">File Name:</th>
                        <td>${details.filename || 'N/A'}</td>
                    </tr>
                    <tr>
                        <th>Type:</th>
                        <td>${details.file_type || details.type || 'N/A'}</td>
                    </tr>
                    <tr>
                        <th>Status:</th>
                        <td><span class="badge ${getStatusBadge(status)}">${status}</span></td>
                    </tr>
                    <tr>
                        <th>Uploaded:</th>
                        <td>${details.upload_time || details.uploaded || 'N/A'}</td>
                    </tr>
                    <tr>
                        <th>Transformed:</th>
                        <td>${details.transform_time || details.transformed || 'N/A'}</td>
                    </tr>
                    <tr>
                        <th>Updated in DB:</th>
                        <td>${details.update_time || details.updated || 'N/A'}</td>
                    </tr>
                    <tr>
                        <th>Records Processed:</th>
                        <td>${details.records_processed || 0}</td>
                    </tr>
                    <tr>
                        <th>Records Failed:</th>
                        <td>${details.records_failed || 0}</td>
                    </tr>
                    ${details.error_message ? `
                    <tr>
                        <th>Error Message:</th>
                        <td class="text-danger">${details.error_message}</td>
                    </tr>` : ''}
                </table>
            </div>
            <div>
                <h6>Details</h6>
                <div class="alert ${status === 'completed' || status === 'success' ? 'alert-success' : 'alert-warning'}">
                    ${details.message || 'No additional details available'}
                </div>
            </div>
        `;
        
        $('#uploadDetailsContent').html(detailsHtml);
        $('#uploadDetailsModal').modal('show');
    }
    
    // Initialize tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});
</script>
{% endblock %}
